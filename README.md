# 眼睛遥控器

本项目基于 Quectel Pi H1 单板电脑开发，充分利用其强大的计算能力和多媒体处理能力，实现了低延迟、较高准确率的眼部追踪功能。

眼睛遥控器是一个智能控制系统，通过检测用户眼部状态来控制视频播放：注视屏幕时继续播放，闭眼或离开屏幕时自动暂停。

核心功能：
- 当检测到用户眼睛睁开并注视屏幕时，系统会自动播放或保持视频播放状态。
- 当检测到用户闭眼、转移视线或离开屏幕时，系统会立即暂停当前播放的视频。
- 支持自动播放下一个视频文件（按文件名字母顺序循环播放）

## 🎯 功能特点

- **眼动检测**: 使用 MediaPipe FaceMesh 实时检测用户眼部状态
- **视线追踪**: 判断用户是否在注视屏幕
- **智能控制**: 根据视线状态自动播放或暂停视频
- **全屏播放模式**: 提供沉浸式观看体验
- **多种视频格式支持**: 支持 MP4、AVI、MOV、MKV 等多种常见视频格式
- **自动播放队列**: 视频播放完成后自动播放同目录下的下一个视频文件
- **双界面模式**: 支持常规窗口模式和全屏播放模式
- **实时状态监控**: 实时显示摄像头 FPS、眼部状态、视线状态等信息

## 🖥️ 界面展示

主界面分为三个主要区域：
1. 摄像头画面显示区 - 实时显示摄像头捕捉的画面及眼部标记点
2. 视频播放区 - 显示当前加载的视频内容
3. 控制面板区 - 包含系统状态信息和各种控制选项

## ⚙️ 工作原理

### 眼部状态检测
- 使用 MediaPipe FaceMesh 检测面部关键点
- 计算眼部纵横比(EAR)判断眼睛开闭状态
- 通过位置方差算法判断头部稳定性

### 视频控制逻辑
- 当用户注视屏幕且眼睛睁开时：继续播放视频
- 当用户闭眼或移开视线超过1秒时：暂停视频播放
- 当未检测到人脸时：暂停视频播放

### 自动播放逻辑
- 视频播放完成后自动查找同目录下按字母顺序排列的下一个 MP4 文件
- 循环播放目录中的所有视频文件

## 📋 系统要求

- Python (3.9-3.12)
- OpenCV-Python (== 4.8.1.78)
- MediaPipe (== 0.10.9)
- NumPy (== 1.24.3)
- PySide6 (== 6.5.3)
- 兼容的摄像头设备

## 🚀 安装与运行

1. 克隆项目代码：
```bash
git clone <repository-url>
cd eye-remote-control
```

2. 安装依赖：
```bash
pip install -r requirements.txt
```

3. 运行程序：
```bash
chmod +x start.sh
./start.sh
```

或者直接运行：
```bash
python3 src/main.py
```

## 🎛️ 使用说明

### 主要操作
- 程序启动后会自动开启摄像头并开始检测
- 点击"选择视频文件"按钮加载视频
- 系统会根据您的视线状态自动控制播放/暂停
- 也可通过视频播放界面下方按钮来控制视频播放

### 控制逻辑
- **注视屏幕+眼睛睁开**: 视频正常播放
- **闭眼或视线移开**: 视频自动暂停
- **人脸离开摄像头范围**: 视频自动暂停

### 界面功能
- **全屏模式**: 点击"F11"或界面上的全屏按钮进入全屏化界面
- **全屏播放模式**: 全屏播放视频，并根据实时识别结果控制视频播放，提供更沉浸式的观看体验
- **显示标记点**: 可视化显示眼部关键点和检测结果
- **启用/禁用检测**: 可手动开关眼部检测功能以及控制摄像头的开启关闭
- **摄像头开关**: 可随时开启或关闭摄像头

## 📁 项目结构

```
eye-remote-control/
├── log_files/                  # 日志文件存储目录
├── src/                        # 源代码目录
│   ├── eye_detector.py         # 眼睛检测核心逻辑
│   ├── fullscreen_player_mode.py  # 全屏播放模式界面
│   ├── log.py                  # 日志记录模块
│   ├── main.py                 # 主程序入口
│   ├── video_capture.py        # 视频采集线程
│   └── video_player.py         # 视频播放器线程
├── README.md                   # 项目说明文档
├── requirements.txt            # 依赖包列表
└── start.sh                    # 启动脚本
```

## 🔧 技术细节

### 眼部状态识别
采用标准6点法计算眼部纵横比(EAR)，公式如下：
```
EAR = (|p2-p6| + |p3-p5|) / (2 * |p1-p4|)
```

其中各点对应眼部关键位置。

### 视线判断
结合眼部中心点和鼻部关键点的位置变化方差来判断用户是否稳定注视屏幕。

### 多状态机跟踪
系统使用多级状态机来跟踪眼部状态和视线状态，提高检测准确性：
- 眼部状态机：open -> closing -> closed -> opening -> open
- 视线状态机：not_gazing -> gazing -> not_gazing

## 🛠️ 配置参数

主要可配置参数位于 [src/eye_detector.py](src/eye_detector.py) 中：
- `EAR_THRESHOLD`: 眼睛闭合阈值
- `GAZING_STABILITY_THRESHOLD`: 注视稳定性阈值
- `GAZING_CONFIRMATION_FRAMES`: 确认注视所需的连续帧数
- `GAZING_BREAK_FRAMES`: 取消注视所需的连续不稳定帧数
- `EAR_BLINK_THRESHOLD`: 眨眼判定阈值
- `EAR_OPEN_THRESHOLD`: 眼睛完全张开阈值
- `BLINK_FRAME_THRESHOLD`: 眨眼持续时间阈值（帧数）

## 📝 注意事项

1. 保持良好的光照条件以获得最佳检测效果
2. 摄像头应正对用户面部，避免过近或过远
3. 避免强烈的背光环境
4. 如遇到检测不准确，可调整相关阈值参数
5. 程序退出时会自动释放所有资源（摄像头、MediaPipe等）

## 🛠️ 故障排除

### 摄像头无法启动
- 检查摄像头是否被其他程序占用
- 确认摄像头设备是否正常工作
- 尝试重启程序或重新连接摄像头

### 视频无法播放
- 检查视频文件格式是否受支持
- 确认视频文件路径是否正确
- 查看日志文件获取详细错误信息

### 检测不准确
- 调整摄像头角度和距离
- 改善环境光线条件
- 在 [src/eye_detector.py](src/eye_detector.py) 中调整相关阈值参数

## 🤝 贡献

欢迎提交 Issue 和 Pull Request 来改进此项目。

## 📄 许可证

本项目仅供学习和研究使用。